やりたいことは「spring-deposit を、multi-authentication の構成（Kong＋Keycloak＋BFF＋Redis＋React）にのせて、`savings-service`/`time-deposit-service` を `service-a`/`service-b` 相当として連携させる」こと。

以下は、**アプリ本体（2つの Spring Boot サービス）はそのまま**に、\*\*認証・認可は Keycloak、入口は Kong、ログイン／セッション管理と集約は BFF（Quarkus）\*\*という、multi-authentication と同じ流れに寄せたものです。

* spring-deposit の現状（ポート: `8081` と `8082`、サービス間は REST 連携）を踏まえています。([GitHub][1])
* 参照先構成（Kong が `/app/*` と `/api/*` を振り分け、BFF が Keycloak と OIDC、BFF が下流に Bearer を転送、Keycloak の realm を同梱）を踏襲します。

---

# 全体像

1. **ディレクトリ追加（spring-deposit リポの中に置く）**

```
spring-deposit-auth/
├─ bff/                 # Quarkus BFF（multi-auth の quarkus-authz を流用/改名）
├─ frontend/            # React(Vite)（multi-auth の frontend を流用）
├─ kong/
│   ├─ kong.yml         # DB-LESS の宣言的設定（Service/Route）
│   └─ kong-nginx-http.conf
├─ realms/
│   └─ demo-realm.json  # Keycloak realm（ユーザ/ロール/クライアント定義）
├─ ops/
│   └─ docker-compose.stack.yaml  # すべてを一括で起動する compose
└─ savings-service/     # 既存（Spring）
└─ time-deposit-service/# 既存（Spring）
```

2. **Spring サービス（2つ）に「Keycloak の JWT 検証」を導入**
   `spring-boot-starter-oauth2-resource-server` を追加し、**BFF がヘッダで渡す Bearer を受け取って検証**。「必要ロール」の宣言でエンドポイントを保護。

3. **`time-deposit-service` → `savings-service` の内部呼び出しで Bearer を伝播**
   SecurityContext から取り出したトークンを **Authorization: Bearer ...** として転送。

4. **Kong（DB-LESS）**
   multi-auth と同様に `/app/*` → frontend、`/api/*`/`/login`/`/logout`/`/secure`/`/hello` → BFF にルーティング。([GitHub][2])

5. **Keycloak**
   `realms/demo-realm.json` を **自動インポート**。演習用ユーザとロール（例：`read`, `user`）を含め、BFF のクライアント（`quarkus-client`）を定義。([GitHub][2])


---

# 動作確認手順（ローカル）

1. **ビルド**

   ```bash
   # Spring
   mvn -f savings-service clean package -DskipTests
   mvn -f time-deposit-service clean package -DskipTests

   # Quarkus
   mvn -f bff clean package -DskipTests

   # Frontend
   (cd frontend && npm ci && npm run build || true) # dev 起動なら build 不要
   ```

2. **起動**

   ```bash
   docker compose -f ops/docker-compose.stack.yaml up -d --build
   ```

3. **ブラウザ**

   * `http://localhost:8000/app/` にアクセス → **ログイン** → `/app/` に戻る（multi-auth と同じ UX）([GitHub][2])
   * BFF 経由 API（例：`/api/me`, `/api/mashup`）で **2サービスに対する権限有無**を確認。権限不足ならフロントで「権限エラー」を表示。([GitHub][2])

---

# 追加の設計メモ（安全性・実運用を見据えて）

* **トークンの時刻ズレ**：`spring.security.oauth2.resourceserver.jwt` に clock-skew を設定可。
* **ロール粒度**：まずは `read`/`user` の 2段で始め、将来 `savings_read`/`time_read` のように分割。
* **観測性**：Actuator（ヘルス）、OpenTelemetry（`traceparent` ヘッダ伝播）を検討。
* **Kong DB モード**：運用で宣言の同期を自動化したい場合は deck を使用（multi-auth README の注意点を参照）。([GitHub][2])
* **直接公開**：必要なら Kong に `/savings` `/time` の route を追加し、Kong 側で JWT/OIDC プラグインを有効にする（BFF バイパス）。

---

## 参考にした現状/仕様

* spring-deposit のサービス構成・ポート・API 概要。([GitHub][1])
* multi-authentication の全体アーキテクチャ、主要エンドポイント、Kong（DB-LESS）設定、Keycloak realm 自動インポートの運用。([GitHub][2])

---


