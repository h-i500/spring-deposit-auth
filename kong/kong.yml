_format_version: "3.0"
_transform: true

services:
  # === BFF (Quarkus) ===
  - name: mashup-savings-term-deposits
    url: http://mashup-savings-term-deposits:8080
    routes:
      # OIDC コールバック（厳密一致）
      - name: secure-callback
        expression: (http.path == "/secure/callback")
        strip_path: false

      # /secure 配下
      - name: secure-all
        expression: (http.path ^= "/secure")
        strip_path: false

      # /api 配下は strip しない（BFF に /api/... のまま渡す）
      - name: api-all
        expression: (http.path ^= "/api")
        strip_path: false

      # Quarkus の OIDC ログアウト
      - name: oidc-logout
        expression: (http.path == "/q/oidc/logout")
        strip_path: false

  # === /auth/* -> BFF の /secure/* へエイリアス ===
  - name: mstd-auth
    url: http://mashup-savings-term-deposits:8080/secure
    routes:
      - name: auth-all
        expression: (http.path ^= "/auth")
        strip_path: true
        preserve_host: false

  # === Frontend (Vite preview on 5173) ===
  - name: frontend
    url: http://frontend:5173
    routes:
      - name: frontend-app
        expression: (http.path ^= "/app")
        strip_path: false
        preserve_host: false



  # === Balance Inquiry (Quarkus) ===
  - name: mashup-balance-inquiry-only
    url: http://mashup-balance-inquiry-only:9000/api/balances
    routes:
      - name: balance-inquiry-route
        expression: (http.path ^= "/balance-inquiry")
        strip_path: true
    # ← サービス直下にプラグインを付与（名前一致が保証できる）
    plugins:
      - name: jwt
        config:
          key_claim_name: iss
          run_on_preflight: false
          # claims_to_verify: ["exp", "nbf"]
          claims_to_verify: ["exp"]   # ← "nbf" は外す

# （トップレベルの plugins: は削除します。あっても良いですが、下のように service を正しく指す必要があります）
# plugins:
#   - name: jwt
#     service: { name: mashup-balance-inquiry-only }  # ← こう書けばOK（または単に文字列でも可）
#     config: ...

# Consumers はそのままでOKだが、rsa_public_key は「公開鍵（BEGIN PUBLIC KEY）」にする
consumers:
  - username: keycloak
    jwt_secrets:
      # 外部から取得したトークン（iss が localhost の場合）
      - algorithm: RS256
        key: http://localhost:8080/realms/demo-realm
        rsa_public_key: |
          -----BEGIN PUBLIC KEY-----
          MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA8R/+L8AwS/OuWqSJ/MCh
          UmXMIbyDdfp25X/uq58GFcFk7SkSjdNNynBQdHiw4xtCKqzK3OdBiAhBPrEbK2f4
          t9roBQBwKCs6t6tSQTxWmCSrBmYQ3wtPqH8nr2ZcS4grxVT8xYOh6oFjxd0KUEUY
          5cYBJvlKaHCIKZ+st8gMcgBXxfBEMfxWTd4Rbk9Gf43xfF8MWE0xJnCflfM/JK+/
          JraCG1Xs2itpaZ5xmn06bme6b6/fIMoqOGYC4Y/CM04ae+pO/0j51SF8kcQa5O9Y
          +Qw4AfC5zei0dZ1h8GoJ0xuvgVWSxfIE4ltHMinmZjv34Mtx3IMrt/dKIqAfmHve
          ywIDAQAB
          -----END PUBLIC KEY-----
      - algorithm: RS256
        key: http://keycloak:8080/realms/demo-realm
        rsa_public_key: |
          -----BEGIN PUBLIC KEY-----
          MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA8R/+L8AwS/OuWqSJ/MCh
          UmXMIbyDdfp25X/uq58GFcFk7SkSjdNNynBQdHiw4xtCKqzK3OdBiAhBPrEbK2f4
          t9roBQBwKCs6t6tSQTxWmCSrBmYQ3wtPqH8nr2ZcS4grxVT8xYOh6oFjxd0KUEUY
          5cYBJvlKaHCIKZ+st8gMcgBXxfBEMfxWTd4Rbk9Gf43xfF8MWE0xJnCflfM/JK+/
          JraCG1Xs2itpaZ5xmn06bme6b6/fIMoqOGYC4Y/CM04ae+pO/0j51SF8kcQa5O9Y
          +Qw4AfC5zei0dZ1h8GoJ0xuvgVWSxfIE4ltHMinmZjv34Mtx3IMrt/dKIqAfmHve
          ywIDAQAB
          -----END PUBLIC KEY-----
