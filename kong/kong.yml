_format_version: "3.0"
_transform: true

services:
  # === BFF (Quarkus) ===
  - name: mashup-savings-term-deposits
    url: http://mashup-savings-term-deposits:8080
    routes:
      # OIDC コールバック（厳密一致）
      - name: secure-callback
        expression: (http.path == "/secure/callback")
        strip_path: false

      # /secure 配下
      - name: secure-all
        expression: (http.path ^= "/secure")
        strip_path: false

      # /api 配下は strip しない（BFF に /api/... のまま渡す）
      - name: api-all
        expression: (http.path ^= "/api")
        strip_path: false

      # Quarkus の OIDC ログアウト
      - name: oidc-logout
        expression: (http.path == "/q/oidc/logout")
        strip_path: false

  # === /auth/* -> BFF の /secure/* へエイリアス ===
  - name: mstd-auth
    url: http://mashup-savings-term-deposits:8080/secure
    routes:
      - name: auth-all
        expression: (http.path ^= "/auth")
        strip_path: true
        preserve_host: false

  # === Frontend (Vite preview on 5173) ===
  - name: frontend
    url: http://frontend:5173
    routes:
      - name: frontend-app
        expression: (http.path ^= "/app")
        strip_path: false
        preserve_host: false



  # === Balance Inquiry (Quarkus) ===
  # - name: mashup-balance-inquiry-only
  #   url: http://mashup-balance-inquiry-only:9000/api/balances
  #   routes:
  #     - name: balance-inquiry-route
  #       expression: (http.path ^= "/balance-inquiry")
  #       strip_path: true
  #   # ← サービス直下にプラグインを付与（名前一致が保証できる）
  #   plugins:
  #     - name: jwt
  #       config:
  #         key_claim_name: iss
  #         run_on_preflight: false
  #         # claims_to_verify: ["exp", "nbf"]
  #         claims_to_verify: ["exp"]   # ← "nbf" は外す
  - name: mashup-balance-inquiry-only
    url: http://mashup-balance-inquiry-only:9000/balances   # ← ここを /balances に
    routes:
      - name: balance-inquiry-route
        expression: (http.path ^= "/balance-inquiry")
        strip_path: true
    plugins:
      - name: jwt
        config:
          key_claim_name: iss
          run_on_preflight: false
          claims_to_verify: ["exp"]

# （トップレベルの plugins: は削除します。あっても良いですが、下のように service を正しく指す必要があります）
# plugins:
#   - name: jwt
#     service: { name: mashup-balance-inquiry-only }  # ← こう書けばOK（または単に文字列でも可）
#     config: ...

# Consumers はそのままでOKだが、rsa_public_key は「公開鍵（BEGIN PUBLIC KEY）」にする
consumers:
  - username: keycloak
    jwt_secrets:
      # 外部から取得したトークン（iss が localhost の場合）
      - algorithm: RS256
        key: http://localhost:8080/realms/demo-realm
        rsa_public_key: |
          -----BEGIN PUBLIC KEY-----
          MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAoBWs6LcLZF2qjAZN5xuB
          I3hFS2SUUFr69MLVwVjza3iIWUg5rOmdFjNr2AahvA7A3ytiG9Ncao7IV8yjGRSC
          i+OLs4Ds30nJWOFRMaORPy7QNBM23bTZrWnbRDKfuQ0bAIooadbQQ3Y0vn6e9Jwd
          Da525YC2VJRa+kmT1wk9PmvOa6vcnMBe6XwMLqEkwgnFpFRiZBIW+LAC47CZWU/H
          JdsQa+oiSYMy/ftnbDbyNHGdUYJD/czjj7ABWKd/cKXeY/zD2CoM6GqMkxUoax0y
          bKPOSXDStPpY+2vrDYeSsWM0RopkXneEDHAeY15RotqyiMcIvmrdkGYB7VQfBjVr
          4QIDAQAB
          -----END PUBLIC KEY-----
      - algorithm: RS256
        key: http://keycloak:8080/realms/demo-realm
        rsa_public_key: |
          -----BEGIN PUBLIC KEY-----
          MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAoBWs6LcLZF2qjAZN5xuB
          I3hFS2SUUFr69MLVwVjza3iIWUg5rOmdFjNr2AahvA7A3ytiG9Ncao7IV8yjGRSC
          i+OLs4Ds30nJWOFRMaORPy7QNBM23bTZrWnbRDKfuQ0bAIooadbQQ3Y0vn6e9Jwd
          Da525YC2VJRa+kmT1wk9PmvOa6vcnMBe6XwMLqEkwgnFpFRiZBIW+LAC47CZWU/H
          JdsQa+oiSYMy/ftnbDbyNHGdUYJD/czjj7ABWKd/cKXeY/zD2CoM6GqMkxUoax0y
          bKPOSXDStPpY+2vrDYeSsWM0RopkXneEDHAeY15RotqyiMcIvmrdkGYB7VQfBjVr
          4QIDAQAB
          -----END PUBLIC KEY-----
