_format_version: "3.0"
_transform: true

services:
  # === BFF (Quarkus) ===
  - name: mashup-savings-term-deposits
    url: http://mashup-savings-term-deposits:8080
    routes:
      # OIDC コールバック（厳密一致）
      - name: secure-callback
        expression: (http.path == "/secure/callback")
        strip_path: false

      # /secure 配下
      - name: secure-all
        expression: (http.path ^= "/secure")
        strip_path: false

      # /api 配下は strip しない（BFF に /api/... のまま渡す）
      - name: api-all
        expression: (http.path ^= "/api")
        strip_path: false

      # Quarkus の OIDC ログアウト
      - name: oidc-logout
        expression: (http.path == "/q/oidc/logout")
        strip_path: false

  # === /auth/* -> BFF の /secure/* へエイリアス ===
  - name: mstd-auth
    url: http://mashup-savings-term-deposits:8080/secure
    routes:
      - name: auth-all
        expression: (http.path ^= "/auth")
        strip_path: true
        preserve_host: false

  # === Frontend (Vite preview on 5173) ===
  - name: frontend
    url: http://frontend:5173
    routes:
      - name: frontend-app
        expression: (http.path ^= "/app")
        strip_path: false
        preserve_host: false



  # === Balance Inquiry (Quarkus) ===
  # - name: mashup-balance-inquiry-only
  #   url: http://mashup-balance-inquiry-only:9000/api/balances
  #   routes:
  #     - name: balance-inquiry-route
  #       expression: (http.path ^= "/balance-inquiry")
  #       strip_path: true
  #   # ← サービス直下にプラグインを付与（名前一致が保証できる）
  #   plugins:
  #     - name: jwt
  #       config:
  #         key_claim_name: iss
  #         run_on_preflight: false
  #         # claims_to_verify: ["exp", "nbf"]
  #         claims_to_verify: ["exp"]   # ← "nbf" は外す
  - name: mashup-balance-inquiry-only
    url: http://mashup-balance-inquiry-only:9000/balances   # ← ここを /balances に
    routes:
      - name: balance-inquiry-route
        expression: (http.path ^= "/balance-inquiry")
        strip_path: true
    plugins:
      - name: jwt
        config:
          key_claim_name: iss
          run_on_preflight: false
          claims_to_verify: ["exp"]

# Consumers はそのままでOKだが、rsa_public_key は「公開鍵（BEGIN PUBLIC KEY）」にする
consumers:
  - username: keycloak
    jwt_secrets:      
      - algorithm: RS256
        key: http://keycloak:8080/realms/demo-realm
        rsa_public_key: |
          -----BEGIN PUBLIC KEY-----
          MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA3XwrvYlRuxrXEXQtvbEY
          xtL31rvQmppqSKxdNWg/xAi3Hpoq7oX083RDyTLgJvXgxGAO2i3eiIQbMSayqUlO
          NtMyeufWEzYX3rcR9If1LLtcnxt+/WKwVdsWsvS8vEXmNUutLRiJvMIdp15MfbZV
          pseh1rx2we6ldRDC4sQDmPm/j2ZsH0nq5DPhfBu9IfBCnltIpSLdve51xavD0HJU
          xuvLKYeLOLrSdNCuHvsoMEyadYXddqvoU1JurgHYvs+CiYjinV0iX4Ox8hhTri8W
          6sBiMNAc5FR9KPDMnuS7gHMl4Czzk+MRa9cLWrTS8NwFjOIYYMGiWSRSIUQbYb/p
          VwIDAQAB
          -----END PUBLIC KEY-----
      # 外部から取得したトークン（iss が localhost の場合）
      # - algorithm: RS256
      #   key: http://localhost:8080/realms/demo-realm
      #   rsa_public_key: |
      #     -----BEGIN PUBLIC KEY-----
      #     MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0V2WX9YeNbXE4I5CNoRt
      #     UvqaU+cSbZaa5wKqMtbZ4wZNzoR3v5VrdpfyYawK5EVXm8TjbzQA9tUNN0acm4rv
      #     6GkOuEOKVjW5bk/wnAsM0IyaMIlLf5Y53FXwfSxC003GqkJPdUrDY9icYEsGWDOE
      #     t+zjRWdN+9aL6+Bj85DKdllaI2fNMvSOQftJ/73iWWPS60UnyxPpdQz/8uca3CK5
      #     vy+s3jGHPR6L0ANJAtX8X+xllEpzSetmaRIC47CZkuVj7G+9enTcGtqFpZLu1k4o
      #     A7xJwZs1QIwLe51QA7VhJrCIfR+M56VIdDLtP4ylRkXb3B+uNO8mixHeobqHAPEK
      #     bwIDAQAB
      #     -----END PUBLIC KEY-----
